# Domain — Agents

## Core Principles

- Agent is a User: Agent references `userId` from `users` table
- Belongs to Unit: Agent is assigned to exactly ONE unit (Phase 1)
- Minimal Details: Basic personal info, contact, optional address
- Admin-Defined Code: Agent code unique within unit
- Status Management: Active, Inactive, Suspended, Terminated
- Phase 1: No transfers between units, no member reassignments on status change

---

## Domain Model

### Entity: Agent

```js
Agent {
  agentId: UUID

  // Hierarchy (belongs to unit)
  unitId: UUID // Parent unit
  areaId: UUID // Denormalized from unit
  forumId: UUID // Denormalized from unit

  // Identification
  agentCode: string // Admin-defined, unique within unit

  // User reference (Agent IS a user)
  userId: UUID // References users.userId

  // Contact Details
  contactNumber: string
  alternateContactNumber: string?

  // Status
  agentStatus: enum [Active, Inactive, Suspended, Terminated]
  // Phase 1: Only Active and Terminated used
  // Phase 2: Inactive (temporary), Suspended (disciplinary)

  // Statistics (computed/cached)
  totalActiveMembers: int // Count of members with status = Active
  totalRegistrations: int // All-time count of members registered by this agent

  // Metadata
  joinedDate: date // When agent started
  terminatedDate: date? // When agent was terminated
  terminationReason: string? // Why agent was terminated

  // Timestamps
  createdAt: timestamp
  createdBy: UUID
  updatedAt: timestamp
  updatedBy: UUID?
}
```

### Business Rules

**Creation**

- Agent must belong to an existing active unit
- `agentCode` must be unique within the unit
- `userId` must reference an existing active user
- User cannot be an agent in multiple units simultaneously (Phase 1)
- `contactNumber` is required
- Only Super Admin, Forum Admin (of parent forum), Area Admin (of parent area), or Unit Admin (of parent unit) can create agents
- `joinedDate` cannot be in the future

**Status**

- Active: Agent can register members, handle transactions
- Terminated: Agent permanently removed (Phase 1)
- Inactive: Temporary deactivation (Phase 2)
- Suspended: Disciplinary action (Phase 2)

**Phase 1 Constraints**

- No agent transfers between units
- No member reassignments when agent status changes
- Agent must have zero active members before termination

**Phase 2 Features (Future)**

- Transfer agent to another unit (with or without members)
- Reassign members to another agent
- Temporary inactivation (without termination)
- Suspension with automatic reactivation date

---

## Commands

### 1. RegisterAgent

**Triggered by:** Super Admin, Forum Admin, Area Admin, Unit Admin (of parent unit)

**Input:**

```json
{
  "unitId": "uuid",
  "agentCode": "string",
  "email": "string",
  "personalDetails": {
    "firstName": "string",
    "lastName": "string",
  },
  "contactDetails": {
    "contactNumber": "string",
    "alternateContactNumber": "string?"
  },
  "joinedDate": "date",
  "createdBy": "uuid"
}
```

**Preconditions:**

- `unitId` references an existing unit
- `agentCode` is unique within the unit
- `email` is unique (not already in `users` table). 
- email not stored in agents table, but in users table.
- User (`createdBy`) has permission to create agents in this unit
- `joinedDate` <= today

**Validations:**

- `agentCode`: required, alphanumeric + hyphen/underscore, 3-50 chars
- `email`: required, valid email format, unique
- `firstName`, `lastName`: required, 2-100 chars each
- `contactNumber`: required, valid phone format

**Backend Logic:**

```js
async function registerAgent(input) {
  return await db.transaction(async (trx) => {

    // 1. Check permission

    // 2. Get unit and validate

    // 3. Validate agentCode is unique within unit
    // 5. Check if email already exists in local db and supabase

    // 6. Create user in Supabase
    // 7. Create local user record

    // 8. Create agent record
    // 9. Get Agent role
    // 10. Assign Agent role to user
    // 11. Generate invitation link for password setup

    // 12. Emit event
    await emitEvent('AgentRegistered', {
      agentId: agent.agentId,
      userId: localUser.userId,
      unitId: input.unitId,
      areaId: unit.areaId,
      forumId: unit.forumId,
      agentCode: agent.agentCode,
      email: input.email,
      createdBy: input.createdBy
    });

    return agent;
  });
}
```

**Outcome:**

- User created in Supabase
- User created in local DB
- Agent record created with status "Active"
- Agent role assigned to user
- Invitation email sent for password setup
- Event: `AgentRegistered`

**Returns:**

```json
{
  "agentId": "uuid",
  "userId": "uuid",
  "agentCode": "AG001",
  "email": "agent@example.com",
  "invitationSent": true
}
```

---

### 2. UpdateAgent

**Triggered by:** Super Admin, Forum Admin, Area Admin, Unit Admin, Agent (self)

**Input:**

```json
{
  "agentId": "uuid",
  "personalDetails": {
    "firstName": "string?",
    "lastName": "string?",
  },
  "contactDetails": {
    "contactNumber": "string?",
    "alternateContactNumber": "string?"
  },
  "updatedBy": "uuid"
}
```

Note: `agentCode`, `unitId`, `userId`, `email`, `joinedDate` cannot be updated

**Preconditions:**

- Agent exists
- If self-update: `updatedBy` must be the agent's `userId`
- If admin update: `updatedBy` must have permission

**Backend Logic:**

```js
async function updateAgent(input) {
  return await db.transaction(async (trx) => {

    // 1. Get agent
    // 2. Check permission
    const isSelfUpdate = (input.updatedBy === agent.userId);

    if (!isSelfUpdate) {
      const canUpdate = await hasPermission(
        input.updatedBy,
        'agent.update',
        { unitId: agent.unitId }
      );

      if (!canUpdate) {
        throw new Error('Not authorized to update this agent');
      }
    }

    // 3. Build updates object
    // 4. Update agent
    // 5. If name changed, update user table too

    // 6. Emit event
    await emitEvent('AgentUpdated', {
      agentId: input.agentId,
      updates,
      updatedBy: input.updatedBy
    });

    return await db.agents.findByPk(input.agentId, { transaction: trx });
  });
}
```

**Outcome:**

- Agent details updated
- If name changed, `users` table also updated
- Event: `AgentUpdated`

---

### 3. TerminateAgent (Phase 1)

**Triggered by:** Super Admin, Forum Admin, Area Admin, Unit Admin

**Input:**

```json
{
  "agentId": "uuid",
  "terminationReason": "string",
  "terminatedDate": "date",
  "terminatedBy": "uuid"
}
```

**Preconditions:**

- Agent exists with status "Active"
- Agent has zero active members (Phase 1 constraint)
- User (`terminatedBy`) has permission to terminate agents

**Backend Logic:**

```js
async function terminateAgent(input) {
  return await db.transaction(async (trx) => {

    // 1. Get agent
    // 2. Check permission
    // 3. Phase 1: Check agent has no active members

    // 4. Update agent status

    // 5. Deactivate user account
    // 6. Revoke agent role

    // 7. Deactivate user in Supabase (optional, for extra security)

    // 8. Emit event
    await emitEvent('AgentTerminated', {
      agentId: input.agentId,
      userId: agent.userId,
      unitId: agent.unitId,
      terminationReason: input.terminationReason,
      terminatedBy: input.terminatedBy
    });

    return await db.agents.findByPk(input.agentId, { transaction: trx });
  });
}
```

**Outcome:**

- Agent status → "Terminated"
- `terminatedDate` and `terminationReason` set
- User account deactivated (`isActive` → `false`)
- Agent role revoked
- Event: `AgentTerminated`

---

### 4. GetAgentDetails

**Triggered by:** Any authenticated user (with permission)

**Input:**

```json
{
  "agentId": "uuid",
  "requestedBy": "uuid"
}
```

---

### 5. ListAgentsByUnit

**Triggered by:** Admin users

**Input:**

```json
{
  "unitId": "uuid",
  "status": "Active|Terminated?", // Optional filter
  "page": 1,
  "limit": 20,
  "requestedBy": "uuid"
}
```

---

### 6. GetAgentStatistics

**Triggered by:** Agent (self) or Admin

**Input:**

```json
{
  "agentId": "uuid",
  "requestedBy": "uuid"
}
```

**Backend Logic:**

```js
async function getAgentStatistics(agentId, requestedBy) {
  // 1. Get agent
  // 2. Check permission
  // 3. Compute statistics
    // totalMembers
    // activeMembers
    // suspendedMembers
    // pendingRegistrations

  return stats;
}
```

---

## Database Schema (Agent Table)

```sql
CREATE TABLE agents (
  agent_id UUID PRIMARY KEY,

  -- Hierarchy
  unit_id UUID NOT NULL REFERENCES units(unit_id),
  area_id UUID NOT NULL REFERENCES areas(area_id), -- Denormalized
  forum_id UUID NOT NULL REFERENCES forums(forum_id), -- Denormalized

  -- Identification
  agent_code VARCHAR(50) NOT NULL,

  -- User reference
  user_id UUID NOT NULL REFERENCES users(user_id),

  -- Contact Details
  contact_number VARCHAR(20) NOT NULL,
  alternate_contact_number VARCHAR(20),

  -- Status
  agent_status VARCHAR(50) DEFAULT 'Active', -- Active, Inactive, Suspended, Terminated

  -- Statistics
  total_active_members INT DEFAULT 0,
  total_registrations INT DEFAULT 0,

  -- Metadata
  joined_date DATE NOT NULL,
  terminated_date DATE,
  termination_reason TEXT,

  -- Timestamps
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by UUID NOT NULL REFERENCES users(user_id),
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_by UUID REFERENCES users(user_id),

  -- Constraints
  UNIQUE(unit_id, agent_code), -- Agent code unique within unit
  CONSTRAINT chk_agent_age CHECK (date_of_birth <= CURRENT_DATE - INTERVAL '18 years')
);

-- Indexes
CREATE INDEX idx_agents_unit ON agents(unit_id);
CREATE INDEX idx_agents_area ON agents(area_id);
CREATE INDEX idx_agents_forum ON agents(forum_id);
CREATE INDEX idx_agents_user ON agents(user_id);
CREATE INDEX idx_agents_status ON agents(agent_status);
CREATE INDEX idx_agents_code ON agents(unit_id, agent_code);
```

---

## Validation Rules Summary

### Registration

- `agentCode`: required, alphanumeric + hyphen/underscore, 3-50 chars, unique within unit
- `email`: required, valid format, unique globally
- `firstName`, `lastName`: required, 2-100 chars
- `contactNumber`: required, valid phone format
- `joinedDate`: required, cannot be in future

### Update

- Cannot update: `agentCode`, `unitId`, `userId`, `email`, `joinedDate`
- Can update: personal details, contact details

### Termination

- Can only terminate agents with status "Active"
- Phase 1: Agent must have zero active members
- `terminationReason`: required, min 10 chars

---

## Events Emitted

- `AgentRegistered` - When agent is created
- `AgentUpdated` - When agent details updated
- `AgentTerminated` - When agent is terminated
- `AgentMemberCountUpdated` - When member statistics change (triggered by member operations)

---

## Summary: Commands List

- `RegisterAgent` (Super Admin, Forum Admin, Area Admin, Unit Admin)
- `UpdateAgent` (Admins, Agent self)
- `TerminateAgent` (Super Admin, Forum Admin, Area Admin, Unit Admin) - Phase 1
- `GetAgentDetails` (Admins, Agent self)
- `ListAgentsByUnit` (Admins)
- `GetAgentStatistics` (Admins, Agent self)