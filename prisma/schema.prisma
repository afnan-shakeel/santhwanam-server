// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Domain: IAM - User
// See `docs/domain/1.iam.md` for the canonical shape.
model User {
  userId        String   @id @default(uuid())
  externalAuthId String  @unique
  email         String   @unique
  firstName     String?
  lastName      String?
  isActive      Boolean  @default(true)
  userMetadata  Json?
  createdAt     DateTime @default(now())
  lastSyncedAt  DateTime?
  userRoles     UserRole[]
  passwordResetTokens PasswordResetToken[]
}

// Enums for role scope and user role scope
enum ScopeType {
  None
  Forum
  Area
  Unit
  Agent
}

model Role {
  roleId       String   @id @default(uuid())
  roleCode     String   @unique
  roleName     String
  description  String?
  scopeType    ScopeType
  isActive     Boolean  @default(true)
  isSystemRole Boolean  @default(false)
  createdAt    DateTime @default(now())
  createdBy    String?
  updatedAt    DateTime?

  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  permissionId   String   @id @default(uuid())
  permissionCode String   @unique
  permissionName String
  description    String?
  module         String?
  action         String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  createdBy      String?

  rolePermissions RolePermission[]
}

model RolePermission {
  rolePermissionId String   @id @default(uuid())
  role             Role     @relation(fields: [roleId], references: [roleId])
  roleId           String
  permission       Permission @relation(fields: [permissionId], references: [permissionId])
  permissionId     String
  conditions       Json?
  assignedAt       DateTime @default(now())
  assignedBy       String?
}

model UserRole {
  userRoleId     String   @id @default(uuid())
  user           User     @relation(fields: [userId], references: [userId])
  userId         String
  role           Role     @relation(fields: [roleId], references: [roleId])
  roleId         String
  scopeEntityType ScopeType?
  scopeEntityId  String?
  isActive       Boolean  @default(true)
  assignedAt     DateTime @default(now())
  assignedBy     String?
  revokedAt      DateTime?
  revokedBy      String?
}

// Domain: Event Bus - Event Store for Audit Trail
model Event {
  eventId       String   @id @default(uuid())
  eventType     String
  aggregateId   String?
  eventData     Json
  userId        String?
  ipAddress     String?
  timestamp     DateTime @default(now())

  @@index([eventType])
  @@index([aggregateId])
  @@index([timestamp])
}

// Password reset tokens for backend-controlled reset flow
model PasswordResetToken {
  tokenId    String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [userId])
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([tokenHash])
  @@index([userId, expiresAt])
}

// Domain: Approval Workflow
// See `docs/domain/2.approval_workflow.md` for details

enum WorkflowModule {
  Membership
  Wallet
  Claims
  Contributions
  Organization
}

enum ApproverType {
  Role
  SpecificUser
  Hierarchy
}

enum HierarchyLevel {
  Unit
  Area
  Forum
}

enum ApprovalRequestStatus {
  Pending
  Approved
  Rejected
  Cancelled
}

enum ApprovalStageStatus {
  Pending
  Approved
  Rejected
  Skipped
}

enum ApprovalDecision {
  Approve
  Reject
}

model ApprovalWorkflow {
  workflowId        String   @id @default(uuid())
  workflowCode      String   @unique
  workflowName      String
  description       String?
  module            WorkflowModule
  entityType        String
  isActive          Boolean  @default(true)
  requiresAllStages Boolean  @default(true)
  createdAt         DateTime @default(now())
  createdBy         String?
  updatedAt         DateTime?
  updatedBy         String?

  stages            ApprovalStage[]
  requests          ApprovalRequest[]

  @@index([workflowCode])
  @@index([isActive])
}

model ApprovalStage {
  stageId        String         @id @default(uuid())
  workflow       ApprovalWorkflow @relation(fields: [workflowId], references: [workflowId])
  workflowId     String
  stageName      String
  stageOrder     Int
  approverType   ApproverType
  roleId         String?
  userId         String?
  hierarchyLevel HierarchyLevel?
  isOptional     Boolean        @default(false)
  autoApprove    Boolean        @default(false)
  createdAt      DateTime       @default(now())

  executions     ApprovalStageExecution[]

  @@unique([workflowId, stageOrder])
  @@index([workflowId, stageOrder])
}

model ApprovalRequest {
  requestId         String                @id @default(uuid())
  workflow          ApprovalWorkflow      @relation(fields: [workflowId], references: [workflowId])
  workflowId        String
  entityType        String
  entityId          String
  forumId           String?
  areaId            String?
  unitId            String?
  requestedBy       String
  requestedAt       DateTime
  status            ApprovalRequestStatus @default(Pending)
  currentStageOrder Int?
  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime?

  stageExecutions   ApprovalStageExecution[]

  @@index([entityType, entityId])
  @@index([status])
  @@index([requestedBy])
}

model ApprovalStageExecution {
  executionId        String               @id @default(uuid())
  request            ApprovalRequest      @relation(fields: [requestId], references: [requestId])
  requestId          String
  stage              ApprovalStage        @relation(fields: [stageId], references: [stageId])
  stageId            String
  stageOrder         Int
  status             ApprovalStageStatus  @default(Pending)
  assignedApproverId String?
  reviewedBy         String?
  reviewedAt         DateTime?
  decision           ApprovalDecision?
  comments           String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime?

  @@index([requestId])
  @@index([assignedApproverId, status])
}

// Domain: Organization Bodies
// See `docs/domain/3.organization_bodies.md` for details

model Forum {
  forumId         String   @id @default(uuid())
  forumCode       String   @unique
  forumName       String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  areas           Area[]

  @@index([forumCode])
  @@index([adminUserId])
}

model Area {
  areaId          String   @id @default(uuid())
  forum           Forum    @relation(fields: [forumId], references: [forumId])
  forumId         String
  areaCode        String
  areaName        String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  units           Unit[]

  @@unique([forumId, areaCode])
  @@index([forumId])
  @@index([adminUserId])
}

model Unit {
  unitId          String   @id @default(uuid())
  area            Area     @relation(fields: [areaId], references: [areaId])
  areaId          String
  forumId         String
  unitCode        String
  unitName        String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  @@unique([areaId, unitCode])
  @@index([areaId])
  @@index([forumId])
  @@index([adminUserId])
}
