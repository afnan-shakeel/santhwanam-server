// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Domain: IAM - User
// See `docs/domain/1.iam.md` for the canonical shape.
model User {
  userId        String   @id @default(uuid())
  externalAuthId String  @unique
  email         String   @unique
  firstName     String?
  lastName      String?
  isActive      Boolean  @default(true)
  userMetadata  Json?
  createdAt     DateTime @default(now())
  lastSyncedAt  DateTime?
  userRoles     UserRole[]
  passwordResetTokens PasswordResetToken[]
  agents        Agent[]
}

// Enums for role scope and user role scope
enum ScopeType {
  None
  Forum
  Area
  Unit
  Agent
}

model Role {
  roleId       String   @id @default(uuid())
  roleCode     String   @unique
  roleName     String
  description  String?
  scopeType    ScopeType
  isActive     Boolean  @default(true)
  isSystemRole Boolean  @default(false)
  createdAt    DateTime @default(now())
  createdBy    String?
  updatedAt    DateTime?

  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  permissionId   String   @id @default(uuid())
  permissionCode String   @unique
  permissionName String
  description    String?
  module         String?
  action         String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  createdBy      String?

  rolePermissions RolePermission[]
}

model RolePermission {
  rolePermissionId String   @id @default(uuid())
  role             Role     @relation(fields: [roleId], references: [roleId])
  roleId           String
  permission       Permission @relation(fields: [permissionId], references: [permissionId])
  permissionId     String
  conditions       Json?
  assignedAt       DateTime @default(now())
  assignedBy       String?
}

model UserRole {
  userRoleId     String   @id @default(uuid())
  user           User     @relation(fields: [userId], references: [userId])
  userId         String
  role           Role     @relation(fields: [roleId], references: [roleId])
  roleId         String
  scopeEntityType ScopeType?
  scopeEntityId  String?
  isActive       Boolean  @default(true)
  assignedAt     DateTime @default(now())
  assignedBy     String?
  revokedAt      DateTime?
  revokedBy      String?
}

// Domain: Event Bus - Event Store for Audit Trail
model Event {
  eventId       String   @id @default(uuid())
  eventType     String
  aggregateId   String?
  eventData     Json
  userId        String?
  ipAddress     String?
  timestamp     DateTime @default(now())

  @@index([eventType])
  @@index([aggregateId])
  @@index([timestamp])
}

// Password reset tokens for backend-controlled reset flow
model PasswordResetToken {
  tokenId    String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [userId])
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([tokenHash])
  @@index([userId, expiresAt])
}

// Domain: Approval Workflow
// See `docs/domain/2.approval_workflow.md` for details

enum WorkflowModule {
  Membership
  Wallet
  Claims
  Contributions
  Organization
}

enum ApproverType {
  Role
  SpecificUser
  Hierarchy
}

enum HierarchyLevel {
  Unit
  Area
  Forum
}

enum ApprovalRequestStatus {
  Pending
  Approved
  Rejected
  Cancelled
}

enum ApprovalStageStatus {
  Pending
  Approved
  Rejected
  Skipped
}

enum ApprovalDecision {
  Approve
  Reject
}

model ApprovalWorkflow {
  workflowId        String   @id @default(uuid())
  workflowCode      String   @unique
  workflowName      String
  description       String?
  module            WorkflowModule
  entityType        String
  isActive          Boolean  @default(true)
  requiresAllStages Boolean  @default(true)
  createdAt         DateTime @default(now())
  createdBy         String?
  updatedAt         DateTime?
  updatedBy         String?

  stages            ApprovalStage[]
  requests          ApprovalRequest[]

  @@index([workflowCode])
  @@index([isActive])
}

model ApprovalStage {
  stageId        String         @id @default(uuid())
  workflow       ApprovalWorkflow @relation(fields: [workflowId], references: [workflowId])
  workflowId     String
  stageName      String
  stageOrder     Int
  approverType   ApproverType
  roleId         String?
  userId         String?
  hierarchyLevel HierarchyLevel?
  isOptional     Boolean        @default(false)
  autoApprove    Boolean        @default(false)
  createdAt      DateTime       @default(now())

  executions     ApprovalStageExecution[]

  @@unique([workflowId, stageOrder])
  @@index([workflowId, stageOrder])
}

model ApprovalRequest {
  requestId         String                @id @default(uuid())
  workflow          ApprovalWorkflow      @relation(fields: [workflowId], references: [workflowId])
  workflowId        String
  entityType        String
  entityId          String
  forumId           String?
  areaId            String?
  unitId            String?
  requestedBy       String
  requestedAt       DateTime
  status            ApprovalRequestStatus @default(Pending)
  currentStageOrder Int?
  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime?

  stageExecutions   ApprovalStageExecution[]
  agents            Agent[]

  @@index([entityType, entityId])
  @@index([status])
  @@index([requestedBy])
}

model ApprovalStageExecution {
  executionId        String               @id @default(uuid())
  request            ApprovalRequest      @relation(fields: [requestId], references: [requestId])
  requestId          String
  stage              ApprovalStage        @relation(fields: [stageId], references: [stageId])
  stageId            String
  stageOrder         Int
  status             ApprovalStageStatus  @default(Pending)
  assignedApproverId String?
  reviewedBy         String?
  reviewedAt         DateTime?
  decision           ApprovalDecision?
  comments           String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime?

  @@index([requestId])
  @@index([assignedApproverId, status])
}

// Domain: Organization Bodies
// See `docs/domain/3.organization_bodies.md` for details

model Forum {
  forumId         String   @id @default(uuid())
  forumCode       String   @unique
  forumName       String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  areas           Area[]

  @@index([forumCode])
  @@index([adminUserId])
}

model Area {
  areaId          String   @id @default(uuid())
  forum           Forum    @relation(fields: [forumId], references: [forumId])
  forumId         String
  areaCode        String
  areaName        String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  units           Unit[]

  @@unique([forumId, areaCode])
  @@index([forumId])
  @@index([adminUserId])
}

model Unit {
  unitId          String   @id @default(uuid())
  area            Area     @relation(fields: [areaId], references: [areaId])
  areaId          String
  forumId         String
  unitCode        String
  unitName        String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  agents          Agent[]
  members         Member[]

  @@unique([areaId, unitCode])
  @@index([areaId])
  @@index([forumId])
  @@index([adminUserId])
}

// Domain: Agents
// See `docs/domain/4.agents.md` for details

enum RegistrationStatus {
  Draft
  PendingApproval
  Approved
  Rejected
}

enum AgentStatus {
  Active
  Inactive
  Suspended
  Terminated
}

enum Gender {
  Male
  Female
  Other
}

model Agent {
  agentId                  String             @id @default(uuid())
  agentCode                String
  registrationStatus       RegistrationStatus @default(Draft)
  approvalRequest          ApprovalRequest?   @relation(fields: [approvalRequestId], references: [requestId])
  approvalRequestId        String?

  // Hierarchy (denormalized for query efficiency)
  unit                     Unit               @relation(fields: [unitId], references: [unitId])
  unitId                   String
  areaId                   String
  forumId                  String

  // User reference (set after approval)
  user                     User?              @relation(fields: [userId], references: [userId])
  userId                   String?

  // Personal Details
  firstName                String
  middleName               String?
  lastName                 String
  dateOfBirth              DateTime
  gender                   Gender

  // Contact Information
  contactNumber            String
  alternateContactNumber   String?
  email                    String             @unique

  // Address (optional)
  addressLine1             String?
  addressLine2             String?
  city                     String?
  state                    String?
  postalCode               String?
  country                  String?

  // Agent Status
  agentStatus              AgentStatus        @default(Active)

  // Statistics
  totalActiveMembers       Int                @default(0)
  totalRegistrations       Int                @default(0)

  // Metadata
  joinedDate               DateTime?
  terminatedDate           DateTime?
  terminationReason        String?

  // Audit fields
  createdAt                DateTime           @default(now())
  createdBy                String
  updatedAt                DateTime?
  updatedBy                String?

  // Relations
  members                  Member[]

  @@unique([unitId, agentCode])
  @@index([unitId])
  @@index([areaId])
  @@index([forumId])
  @@index([userId])
  @@index([email])
  @@index([approvalRequestId])
  @@index([registrationStatus])
  @@index([agentStatus])
}

// Domain: Members
// See `docs/domain/5.membership.md` for details

enum MemberRegistrationStatus {
  Draft
  PendingApproval
  Approved
  Rejected
}

enum MemberRegistrationStep {
  PersonalDetails
  Nominees
  DocumentsPayment
  Completed
}

enum MemberStatus {
  Active
  Frozen
  Suspended
  Closed
  Deceased
}

enum RelationType {
  Father
  Mother
  Spouse
  Son
  Daughter
  Brother
  Sister
  Other
}

enum IdProofType {
  NationalID
  Passport
  DrivingLicense
  VoterID
  Other
}

enum DocumentType {
  NationalID
  Passport
  DrivingLicense
  BirthCertificate
  ResidenceCard
  AddressProof_UtilityBill
  AddressProof_BankStatement
  AddressProof_RentalAgreement
  MemberPhoto
  NomineeIDProof
  Other
}

enum DocumentCategory {
  MemberIdentity
  MemberAddress
  MemberPhoto
  NomineeProof
  Other
}

enum DocumentVerificationStatus {
  Pending
  Verified
  Rejected
}

enum CollectionMode {
  Cash
  BankTransfer
  Cheque
  Online
}

enum PaymentApprovalStatus {
  PendingApproval
  Approved
  Rejected
}

model Member {
  memberId                 String                    @id @default(uuid())
  memberCode               String                    @unique

  // Registration tracking
  registrationStatus       MemberRegistrationStatus  @default(Draft)
  registrationStep         MemberRegistrationStep    @default(PersonalDetails)
  approvalRequestId        String?

  // Personal Details
  firstName                String
  middleName               String?
  lastName                 String
  dateOfBirth              DateTime
  gender                   Gender
  contactNumber            String
  alternateContactNumber   String?
  email                    String?

  // Address
  addressLine1             String
  addressLine2             String?
  city                     String
  state                    String
  postalCode               String
  country                  String

  // Membership details
  tier                     MembershipTier            @relation(fields: [tierId], references: [tierId])
  tierId                   String

  // Hierarchy
  agent                    Agent                     @relation(fields: [agentId], references: [agentId])
  agentId                  String
  unit                     Unit                      @relation(fields: [unitId], references: [unitId])
  unitId                   String
  areaId                   String
  forumId                  String

  // Member Status (after approval)
  memberStatus             MemberStatus?

  // Suspension tracking
  suspensionCounter        Int                       @default(0)
  suspensionReason         String?
  suspendedAt              DateTime?

  // Timestamps
  createdAt                DateTime                  @default(now())
  registeredAt             DateTime?
  updatedAt                DateTime?

  // Audit
  createdBy                String
  approvedBy               String?

  // Relations
  nominees                 Nominee[]
  documents                MemberDocument[]
  payment                  RegistrationPayment?

  @@index([memberCode])
  @@index([registrationStatus])
  @@index([memberStatus])
  @@index([agentId])
  @@index([unitId])
  @@index([tierId])
  @@index([approvalRequestId])
}

model Nominee {
  nomineeId                String                    @id @default(uuid())
  member                   Member                    @relation(fields: [memberId], references: [memberId])
  memberId                 String

  // Nominee details
  name                     String
  relationType             RelationType
  dateOfBirth              DateTime
  contactNumber            String
  alternateContactNumber   String?

  // Address
  addressLine1             String
  addressLine2             String?
  city                     String
  state                    String
  postalCode               String
  country                  String

  // ID Proof
  idProofType              IdProofType
  idProofNumber            String
  idProofDocumentId        String?

  // Priority (Phase 2 - default to 1)
  priority                 Int                       @default(1)

  // Status
  isActive                 Boolean                   @default(true)

  // Timestamps
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime?

  // Relations
  documents                MemberDocument[]

  @@index([memberId])
  @@index([memberId, isActive])
  @@unique([memberId, priority])
}

model MemberDocument {
  documentId               String                    @id @default(uuid())
  member                   Member                    @relation(fields: [memberId], references: [memberId])
  memberId                 String
  nominee                  Nominee?                  @relation(fields: [nomineeId], references: [nomineeId])
  nomineeId                String?

  // Document details
  documentType             DocumentType
  documentCategory         DocumentCategory
  documentName             String

  // File storage
  fileUrl                  String
  fileSize                 Int
  mimeType                 String

  // Metadata
  uploadedBy               String
  uploadedAt               DateTime                  @default(now())

  // Verification
  verificationStatus       DocumentVerificationStatus @default(Pending)
  verifiedBy               String?
  verifiedAt               DateTime?
  rejectionReason          String?

  // Optional
  expiryDate               DateTime?

  // Status
  isActive                 Boolean                   @default(true)

  // Timestamps
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime?

  @@index([memberId])
  @@index([nomineeId])
  @@index([memberId, documentCategory, isActive])
}

model RegistrationPayment {
  paymentId                String                    @id @default(uuid())
  member                   Member                    @relation(fields: [memberId], references: [memberId])
  memberId                 String                    @unique

  // Payment details
  registrationFee          Decimal                   @db.Decimal(15, 2)
  advanceDeposit           Decimal                   @db.Decimal(15, 2)
  totalAmount              Decimal                   @db.Decimal(15, 2)

  // Collection details
  collectedBy              String // AgentId
  collectionDate           DateTime
  collectionMode           CollectionMode
  referenceNumber          String?

  // Approval status
  approvalStatus           PaymentApprovalStatus     @default(PendingApproval)
  approvedBy               String?
  approvedAt               DateTime?
  rejectionReason          String?

  // Timestamps
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime?

  @@index([memberId])
}

model MembershipTier {
  tierId                   String                    @id @default(uuid())
  tierCode                 String                    @unique
  tierName                 String
  description              String?

  // Financial amounts
  registrationFee          Decimal                   @db.Decimal(15, 2)
  advanceDepositAmount     Decimal                   @db.Decimal(15, 2)
  contributionAmount       Decimal                   @db.Decimal(15, 2)
  deathBenefitAmount       Decimal                   @db.Decimal(15, 2)

  // Status
  isActive                 Boolean                   @default(true)
  isDefault                Boolean                   @default(false)

  // Timestamps
  createdAt                DateTime                  @default(now())
  createdBy                String
  updatedAt                DateTime?

  // Relations
  members                  Member[]

  @@index([tierCode])
  @@index([isActive])
  @@index([isDefault])
}

// ===================================
// Domain: General Ledger (GL)
// See `docs/domain/6.gl.md`
// ===================================

enum AccountType {
  Asset
  Liability
  Revenue
  Expense
  Equity
}

enum NormalBalance {
  Debit
  Credit
}

enum EntryStatus {
  Draft
  Posted
  Reversed
}

enum PeriodStatus {
  Open
  Closed
}

// Chart of Accounts
model ChartOfAccount {
  accountId                String                    @id @default(uuid())
  accountCode              String                    @unique
  accountName              String
  accountType              AccountType
  accountCategory          String?

  // Hierarchy
  parentAccount            ChartOfAccount?           @relation("AccountHierarchy", fields: [parentAccountId], references: [accountId])
  parentAccountId          String?
  childAccounts            ChartOfAccount[]          @relation("AccountHierarchy")
  accountLevel             Int                       @default(1)

  // Balance tracking
  normalBalance            NormalBalance
  currentBalance           Decimal                   @db.Decimal(15, 2) @default(0)

  // Status
  isActive                 Boolean                   @default(true)
  isSystemAccount          Boolean                   @default(false)

  // Timestamps
  createdAt                DateTime                  @default(now())
  createdBy                String
  updatedAt                DateTime?
  updatedBy                String?

  // Relations
  journalEntryLines        JournalEntryLine[]

  @@index([accountCode])
  @@index([accountType])
  @@index([isActive])
  @@index([parentAccountId])
  @@index([isSystemAccount])
}

// Journal Entry
model JournalEntry {
  entryId                  String                    @id @default(uuid())
  entryNumber              String                    @unique

  // Entry details
  entryDate                DateTime
  postingDate              DateTime?
  description              String
  reference                String?

  // Source tracking
  sourceModule             String
  sourceEntityId           String?
  sourceTransactionType    String

  // Status
  entryStatus              EntryStatus               @default(Draft)

  // Reversal tracking
  reversedEntry            JournalEntry?             @relation("EntryReversal", fields: [reversedEntryId], references: [entryId])
  reversedEntryId          String?
  reversedByEntry          JournalEntry[]            @relation("EntryReversal")
  reversalReason           String?
  reversedAt               DateTime?
  reversedBy               String?

  // Validation
  totalDebit               Decimal                   @db.Decimal(15, 2) @default(0)
  totalCredit              Decimal                   @db.Decimal(15, 2) @default(0)
  isBalanced               Boolean                   @default(false)

  // Timestamps
  createdAt                DateTime                  @default(now())
  createdBy                String
  postedAt                 DateTime?
  postedBy                 String?
  updatedAt                DateTime?

  // Relations
  lines                    JournalEntryLine[]

  @@index([entryNumber])
  @@index([entryDate])
  @@index([entryStatus])
  @@index([sourceModule, sourceEntityId])
  @@index([reversedEntryId])
  @@index([isBalanced])
}

// Journal Entry Line
model JournalEntryLine {
  lineId                   String                    @id @default(uuid())
  entry                    JournalEntry              @relation(fields: [entryId], references: [entryId], onDelete: Cascade)
  entryId                  String

  lineNumber               Int

  // Account reference
  account                  ChartOfAccount            @relation(fields: [accountId], references: [accountId])
  accountId                String
  accountCode              String
  accountName              String

  // Amounts
  debitAmount              Decimal                   @db.Decimal(15, 2) @default(0)
  creditAmount             Decimal                   @db.Decimal(15, 2) @default(0)

  description              String

  // Timestamps
  createdAt                DateTime                  @default(now())

  @@index([entryId])
  @@index([accountId])
  @@index([entryId, lineNumber])
}

// Fiscal Period
model FiscalPeriod {
  periodId                 String                    @id @default(uuid())
  fiscalYear               Int
  periodNumber             Int
  periodName               String

  startDate                DateTime
  endDate                  DateTime

  status                   PeriodStatus              @default(Open)

  closedAt                 DateTime?
  closedBy                 String?

  createdAt                DateTime                  @default(now())

  @@unique([fiscalYear, periodNumber])
  @@index([fiscalYear])
  @@index([status])
  @@index([startDate, endDate])
}
